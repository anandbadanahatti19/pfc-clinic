generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───

enum Role {
  SUPER_ADMIN
  ADMIN
  RECEPTIONIST
  NURSE
  LAB_TECHNICIAN
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  CASH
  ONLINE
}

enum PaymentStatus {
  PAID
  PENDING
  REFUNDED
}

enum FollowUpStatus {
  PENDING
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum ItemCategory {
  MEDICINE
  CONSUMABLE
  CLEANING
  EQUIPMENT
  OTHER
}

enum TransactionType {
  STOCK_IN
  USED
  ADJUSTED
  RETURNED
}

// ─── Clinic (Tenant) ───

model Clinic {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  abbreviation    String
  tagline         String?
  phone           String?
  email           String?
  address         String?  @db.Text
  city            String?
  logoUrl         String?  @map("logo_url")
  timeSlots       Json     @default("[]") @map("time_slots")
  doctors         Json     @default("[]")
  enabledFeatures Json     @default("{}") @map("enabled_features")
  isActive        Boolean  @default(true) @map("is_active")
  plan            String   @default("basic")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  users          User[]
  patients       Patient[]
  appointments   Appointment[]
  payments       Payment[]
  followUps      FollowUp[]
  inventoryItems InventoryItem[]

  @@map("clinics")
}

// ─── Models ───

model User {
  id        String   @id @default(uuid())
  name      String
  email     String
  password  String
  role      Role     @default(RECEPTIONIST)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Clinic relation (nullable for SUPER_ADMIN)
  clinic   Clinic?  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String?  @map("clinic_id")

  // Relations
  registeredPatients    Patient[]
  createdAppointments   Appointment[]
  receivedPayments      Payment[]
  createdFollowUps      FollowUp[]
  addedInventoryItems   InventoryItem[]
  inventoryTransactions InventoryTransaction[]

  @@unique([email, clinicId])
  @@index([clinicId])
  @@map("users")
}

model Patient {
  id           String   @id @default(uuid())
  name         String
  phone        String
  email        String?
  age          Int?
  gender       String?
  medicalNotes String?  @map("medical_notes") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Clinic relation
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String @map("clinic_id")

  // Who registered this patient
  registeredBy   User?   @relation(fields: [registeredById], references: [id], onDelete: SetNull)
  registeredById String? @map("registered_by")

  // Relations
  appointments Appointment[]
  payments     Payment[]
  followUps    FollowUp[]

  @@index([clinicId])
  @@map("patients")
}

model Appointment {
  id         String            @id @default(uuid())
  date       DateTime          @db.Date
  time       String            // "10:00", "10:30", etc.
  type       String            // Consultation, IVF, Ultrasound, etc.
  doctor     String
  status     AppointmentStatus @default(SCHEDULED)
  notes      String?           @db.Text
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")

  // Clinic relation
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String @map("clinic_id")

  // Relations
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String  @map("patient_id")

  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdById String? @map("created_by")

  payments  Payment[]
  followUps FollowUp[]

  @@index([clinicId, date, time])
  @@map("appointments")
}

model Payment {
  id          String        @id @default(uuid())
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod
  status      PaymentStatus @default(PAID)
  receipt     String        @unique
  description String?
  date        DateTime      @default(now()) @map("payment_date")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Clinic relation
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String @map("clinic_id")

  // Relations
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String  @map("patient_id")

  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  appointmentId String?      @map("appointment_id")

  receivedBy   User?   @relation(fields: [receivedById], references: [id], onDelete: SetNull)
  receivedById String? @map("received_by")

  @@index([clinicId, date])
  @@index([clinicId, patientId])
  @@map("payments")
}

model FollowUp {
  id            String         @id @default(uuid())
  scheduledDate DateTime       @map("scheduled_date") @db.Date
  reason        String
  status        FollowUpStatus @default(PENDING)
  notes         String?        @db.Text
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Clinic relation
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String @map("clinic_id")

  // Relations
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String  @map("patient_id")

  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  appointmentId String?      @map("appointment_id")

  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdById String? @map("created_by")

  @@index([clinicId, scheduledDate, status])
  @@map("follow_ups")
}

model InventoryItem {
  id          String       @id @default(uuid())
  name        String
  category    ItemCategory
  unit        String       // e.g. "bottles", "boxes", "pcs"
  quantity    Int          @default(0)
  minQuantity Int          @map("min_quantity")
  cost        Decimal?     @db.Decimal(10, 2)
  supplier    String?
  notes       String?      @db.Text
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Clinic relation
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicId String @map("clinic_id")

  // Relations
  addedBy   User?   @relation(fields: [addedById], references: [id], onDelete: SetNull)
  addedById String? @map("added_by")

  transactions InventoryTransaction[]

  @@index([clinicId])
  @@map("inventory_items")
}

model InventoryTransaction {
  id        String          @id @default(uuid())
  type      TransactionType
  quantity  Int             // positive = in, negative = out
  reason    String?
  createdAt DateTime        @default(now()) @map("created_at")

  // Relations
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId String        @map("item_id")

  performedBy   User?   @relation(fields: [performedById], references: [id], onDelete: SetNull)
  performedById String? @map("performed_by")

  @@index([itemId, createdAt])
  @@map("inventory_transactions")
}
